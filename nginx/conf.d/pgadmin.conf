upstream pga {
  server unix:///run/pgadmin4/pgadmin4.sock;
}
server {
  listen 80;
  server_name pga.directmandat.com;
  add_header Permissions-Policy "" always;
  return 301 https://$host$request_uri;
}
server {
  listen 443 ssl;
  server_name pga.directmandat.com;
    ssl_certificate /etc/letsencrypt/live/pga.directmandat.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/pga.directmandat.com/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf;
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

  access_log /var/log/nginx/pgadmin.log;
  error_log /var/log/nginx/pgadmin.err;

  auth_basic "Backoffice DirectMandat";
  auth_basic_user_file /etc/nginx/.htpasswd;

  expires -1;

  location = /favicon.ico { access_log off; log_not_found off; }
  location = /robots.txt { access_log off; log_not_found off; }
  location ~ /\. { deny all; access_log off; log_not_found off; }
  location ~ /\.sh { deny all; }

  location / {
    include uwsgi_params;
    uwsgi_pass pga;

    # Forwarded headers (both HTTP_* and plain variants for safety)
    uwsgi_param  HTTP_HOST               $host;
    uwsgi_param  HTTP_X_FORWARDED_HOST   $host;
    uwsgi_param  HTTP_X_FORWARDED_PROTO  $scheme;
    uwsgi_param  HTTP_X_FORWARDED_PORT   $server_port;
    uwsgi_param  HTTP_X_REAL_IP          $remote_addr;
    uwsgi_param  HTTP_X_FORWARDED_FOR    $proxy_add_x_forwarded_for;

    uwsgi_param  X-Forwarded-Host        $host;
    uwsgi_param  X-Forwarded-Proto       $scheme;
    uwsgi_param  X-Real-IP               $remote_addr;
    uwsgi_param  HTTPS                   on;

    # Timeouts (less spurious drops)
    uwsgi_read_timeout    300s;
    uwsgi_send_timeout    120s;
    uwsgi_connect_timeout 15s;

    # Don?t let upstream override your Permissions-Policy
    uwsgi_hide_header Permissions-Policy;
    proxy_hide_header Permissions-Policy;
    add_header Permissions-Policy "" always;
  }
}
